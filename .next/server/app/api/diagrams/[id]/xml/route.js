"use strict";(()=>{var e={};e.id=5711,e.ids=[5711],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},4729:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var a={};t.r(a),t.d(a,{GET:()=>m});var i=t(9303),n=t(8716),o=t(670),s=t(7070),l=t(9949),d=t(384),c=t(2619),u=t(9489);async function m(e,{params:r}){try{let e=await (0,l.ts)();if(!e)return s.NextResponse.json({error:"Unauthorized",message:"Authentication required"},{status:401});let{id:t}=c._F.parse(r),a=await d.p.getDiagramXml(t,e.id);if(!a)return s.NextResponse.json({error:"Not Found",message:"Diagram XML not found or access denied"},{status:404});let i=await d.p.getDiagramById(t,e.id),n=(i?.title||"diagram").replace(/[^\w\s-]/g,"").replace(/\s+/g,"_").slice(0,50).toLowerCase();return new s.NextResponse(a,{status:200,headers:{"Content-Type":"application/xml; charset=utf-8","Content-Disposition":`attachment; filename="${n}.bpmn"`,"Cache-Control":"private, max-age=3600","Access-Control-Allow-Origin":"*","Access-Control-Expose-Headers":"Content-Disposition"}})}catch(e){if(console.error("GET /api/diagrams/[id]/xml error:",e),e instanceof u.j)return s.NextResponse.json({error:"Validation Error",details:e.issues},{status:400});return s.NextResponse.json({error:"Internal Server Error",message:"Failed to fetch diagram XML"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/diagrams/[id]/xml/route",pathname:"/api/diagrams/[id]/xml",filename:"route",bundlePath:"app/api/diagrams/[id]/xml/route"},resolvedPagePath:"/Users/home/Desktop/mvp/app/api/diagrams/[id]/xml/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:f}=p,w="/api/diagrams/[id]/xml/route";function x(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},9949:(e,r,t)=>{t.d(r,{et:()=>s,lx:()=>n,ts:()=>o,xv:()=>l});var a=t(6718),i=t(1615);function n(){let e=(0,i.cookies)();return(0,a.createServerClient)("https://adjdqxptoaecafmmjgtf.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkamRxeHB0b2FlY2FmbW1qZ3RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NTgzOTMsImV4cCI6MjA3MTEzNDM5M30.L_PMZMsTkFklUOx9lNll-s1NiaW9HnGifk-bkB5tdIQ",{cookies:{get:r=>e.get(r)?.value,set(r,t,a){e.set({name:r,value:t,...a})},remove(r,t){e.set({name:r,value:"",...t})}}})}async function o(){let e=n();try{let{data:{user:r},error:t}=await e.auth.getUser();if(t||!r)return null;return r}catch(e){return console.error("Error getting current user:",e),null}}async function s(e){let r=n();try{let{data:t,error:a}=await r.from("profiles").select(`
        *,
        subscriptions (
          plan,
          status,
          current_period_end
        )
      `).eq("id",e).single();if(a)return console.error("Error getting user profile:",a),null;return t}catch(e){return console.error("Error getting user profile:",e),null}}async function l(e){let r=n();try{let{data:t,error:a}=await r.from("profiles").insert({id:e.id,email:e.email,name:e.user_metadata?.full_name||e.email?.split("@")[0]||"User",avatar_url:e.user_metadata?.avatar_url}).select().single();if(a)return console.error("Error creating profile:",a),null;let{error:i}=await r.from("subscriptions").insert({profile_id:e.id,stripe_customer_id:`temp_${e.id}`,plan:"FREE",status:"ACTIVE",current_period_end:new Date(Date.now()+31536e6)});return i&&console.error("Error creating subscription:",i),t}catch(e){return console.error("Error creating user profile:",e),null}}},8643:(e,r,t)=>{t.d(r,{xk:()=>function e(r){if(void 0!==r){if(null===r)return null;if(r instanceof Date)return r.toISOString();if(Array.isArray(r))return r.map(r=>e(r));if("object"==typeof r){let t={};for(let[a,i]of Object.entries(r)){let r=e(i);void 0!==r&&(t[a]=r)}return t}return r}}})},3493:(e,r,t)=>{t.d(r,{_:()=>i});let a=require("@prisma/client"),i=globalThis.prisma??new a.PrismaClient},384:(e,r,t)=>{t.d(r,{p:()=>n});var a=t(3493),i=t(8643);class n{static async createDiagram(e,r){try{if(!await a._.project.findFirst({where:{id:r.projectId,ownerId:e,deletedAt:null}}))return null;return await a._.diagram.create({data:{...r,ownerId:e,version:1}})}catch(e){return console.error("Error creating diagram:",e),null}}static async getDiagramById(e,r){try{return await a._.diagram.findFirst({where:{id:e,ownerId:r,deletedAt:null},include:{versions:{orderBy:{revNumber:"desc"},take:10},project:{select:{id:!0,name:!0,ownerId:!0}}}})}catch(e){return console.error("Error getting diagram by ID:",e),null}}static async getUserDiagrams(e,r,t=1,i=20){try{return await a._.diagram.findMany({where:{ownerId:e,deletedAt:null,...r&&{projectId:r}},include:{project:{select:{id:!0,name:!0}}},orderBy:{updatedAt:"desc"},skip:(t-1)*i,take:i})}catch(e){return console.error("Error getting user diagrams:",e),[]}}static async updateDiagram(e,r,t){try{return await a._.diagram.update({where:{id:e,ownerId:r,deletedAt:null},data:{...t,version:{increment:1}}})}catch(e){return console.error("Error updating diagram:",e),null}}static async saveDiagramContent(e,r,t,i=!1){try{return await a._.$transaction(async a=>{let n=await a.diagram.update({where:{id:e,ownerId:r,deletedAt:null},data:{bpmnXml:t.bpmnXml,...t.title&&{title:t.title},...t.metadata&&{metadata:t.metadata},version:{increment:1}}});if(i){let i=await a.diagramVersion.findFirst({where:{diagramId:e},orderBy:{revNumber:"desc"},select:{revNumber:!0}});await a.diagramVersion.create({data:{diagramId:e,revNumber:(i?.revNumber||0)+1,bpmnXml:t.bpmnXml,metadata:t.metadata||{},authorId:r,changeMessage:"Auto-saved version"}})}return n})}catch(e){return console.error("Error saving diagram content:",e),null}}static async deleteDiagram(e,r){try{return await a._.diagram.update({where:{id:e,ownerId:r,deletedAt:null},data:{deletedAt:new Date}}),!0}catch(e){return console.error("Error deleting diagram:",e),!1}}static async getDiagramXml(e,r){try{let t=await a._.diagram.findFirst({where:{id:e,ownerId:r,deletedAt:null},select:{bpmnXml:!0}});return t?.bpmnXml||null}catch(e){return console.error("Error getting diagram XML:",e),null}}static async getRecentDiagrams(e,r=5){try{return await a._.diagram.findMany({where:{ownerId:e,deletedAt:null},include:{project:{select:{id:!0,name:!0}}},orderBy:{updatedAt:"desc"},take:r})}catch(e){return console.error("Error getting recent diagrams:",e),[]}}static async duplicateDiagram(e,r,t){try{let n=await a._.diagram.findFirst({where:{id:e,ownerId:r,deletedAt:null}});if(!n)return null;return await a._.diagram.create({data:{title:t||`${n.title} (Copy)`,bpmnXml:n.bpmnXml,thumbnailUrl:n.thumbnailUrl,metadata:(0,i.xk)(n.metadata||{}),projectId:n.projectId,ownerId:r,version:1,isPublic:!1}})}catch(e){return console.error("Error duplicating diagram:",e),null}}static async generateThumbnail(e,r,t){try{return await a._.diagram.update({where:{id:e,ownerId:r},data:{thumbnailUrl:t}}),!0}catch(e){return console.error("Error updating diagram thumbnail:",e),!1}}}},2619:(e,r,t)=>{t.d(r,{Bh:()=>l,Ow:()=>o,XM:()=>n,_F:()=>s});var a=t(1598);let i=a.Ry({description:a.Z_().max(500).optional(),tags:a.IX(a.Z_().max(50)).max(10).optional(),category:a.Km(["business","technical","process","other"]).optional(),createdWith:a.Z_().max(100).optional(),format:a.Z_().max(50).optional(),elementCount:a.Rx().int().min(0).max(1e4).optional(),lastModified:a.Z_().datetime().optional(),lastSaved:a.Z_().datetime().optional(),customFields:a.IM(a.Z_().max(50),a.G0([a.Z_().max(200),a.Rx(),a.O7()])).optional()}).strict(),n=a.Ry({title:a.Z_().min(1,"Diagram title is required").max(200,"Title must be less than 200 characters").trim(),bpmnXml:a.Z_().optional().nullable(),projectId:a.Z_().cuid("Invalid project ID"),metadata:i.optional().default({}),isPublic:a.O7().optional().default(!1)}),o=a.Ry({title:a.Z_().min(1,"Diagram title is required").max(200,"Title must be less than 200 characters").trim().optional(),bpmnXml:a.Z_().optional().nullable(),metadata:i.optional(),isPublic:a.O7().optional()}),s=a.Ry({id:a.Z_().cuid("Invalid diagram ID")}),l=a.Ry({bpmnXml:a.Z_().min(1,"BPMN XML is required"),title:a.Z_().min(1,"Diagram title is required").max(200,"Title must be less than 200 characters").trim().optional(),metadata:i.optional()})}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9276,5972,4305,1598],()=>t(4729));module.exports=a})();